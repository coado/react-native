name: Run API Breaking Change Detection

on:
  pull_request:
    types: [synchronize, opened]
permissions:
  pull-requests: write
  issues: write
env:
  SNAPSHOT_PATH: packages/react-native/ReactNativeApi.d.ts
jobs:
  check-api-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Save previous snapshot
        run: |
          mkdir ${{ runner.temp }}/snapshot
          # git show HEAD^:${{ env.SNAPSHOT_PATH }} > ${{ runner.temp }}/snapshot/ReactNativeApi.d.ts
          echo "" > ${{ runner.temp }}/snapshot/ReactNativeApi.d.ts
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22"
      - name: Run yarn
        uses: ./.github/actions/yarn-install
      - name: Run breaking change detection
        run: |
          node ./scripts/diff-api-snapshot \
          ${{ runner.temp }}/snapshot/ReactNativeApi.d.ts \
          ${{ github.workspace }}/${{ env.SNAPSHOT_PATH }} \
          > ${{ runner.temp }}/snapshot/output.json
      - name: Run diff-api-snapshot bot
        shell: bash
        run: ./.github/workflow-scripts/exec_swallow_error.sh ./.github/workflow-scripts/diff_api_snapshot.sh
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
          GITHUB_PR_NUMBER: ${{ github.event.number }}
